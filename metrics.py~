#!/usr/bin/python

import datetime
import json
import requests
import sys
import time

s = requests.session()


period_start = datetime.datetime(2015, 7, 1)


with open('/home/mikal/src/stackforge/stackalytics/etc/default_data.json') as f:
    users = json.loads(f.read())

target_users = []
for user in users['users']:
    try:
        username = user.get('launchpad_id')
        if not username:
            username = user['github_id']

        for company in user['companies']:
            if company.get('end_date'):
                end = datetime.datetime.strptime(company.get('end_date'),
                                                 '%Y-%b-%d')
                if end < period_start:
                    continue

            if company['company_name'] in ['Intel', 'Rackspace']:
                if not username in target_users:
                    target_users.append(username)

    except Exception as e:
        print
        print user
        print
        print e
        sys.exit(1)

print 'Found %d users' % len(target_users)

events = {}

for username in target_users:
    for metric in ['marks', 'commits', 'resolved-bugs']:
        d = datetime.datetime.now()
        count = 0
        while d > period_start:
            previous_d = d
            url = ('http://stackalytics.com/api/1.0/activity?'
                   'user_id=%s&page_size=100&start_record=%d&'
                   'metric=%s'
                    %(username, count * 100, metric))

            reviews = s.get(url).json()
            count += 1

            for act in reviews['activity']:
                when = datetime.datetime.fromtimestamp(act['date'])
                d = when

                key = (when.year, when.month, when.day)
                events.setdefault(key, {})
                events[key].setdefault(username, [])

                try:
                    bugs_referenced = act.get('bug_id_count', 0)
                    if bugs_referenced > 0:
                        events[key][username].append(('referenced-bugs',
                                                      bugs_referenced,
                                                      act['module']))

                    value_keys = {'marks': 'value',
                                  'commits': 'loc',
                                  'resolved-bugs': 'importance'}

                    events[key][username].append((act.get('type', metric),
                                                  act[value_keys[metric]],
                                                  act['module']))
                except Exception as e:
                    print
                    print url
                    print
                    print 'Could not process %s' % repr(act)
                    print
                    print e
                    sys.exit(1)


            if previous_d == d:
                break    

d = period_start
while d < datetime.datetime.now():
    print '%s' % string.strftime(d, '%Y-%b-%d')
